#!/usr/bin/env ruby
RAILS_ENV = 'production'
require File.join(File.dirname(__FILE__), 'config', 'environment.rb')

FileUtils.mkdir_p(File.join(RAILS_ROOT, 'tmp', 'blog'))

blog = Blog.find(:first)

blog.articles.each_with_index do |article, index|
  created_datestamp = article.created_at.strftime('%Y-%m-%d')
  filename = File.join(RAILS_ROOT, 'tmp', 'blog', "#{created_datestamp}-#{article.permalink}.txt")
  File.open(filename, 'w') do |file|
    required_keys = %w(id guid title permalink keywords created_at updated_at)
    attributes = article.attributes.reject { |key, value| !required_keys.include?(key) }
    attributes['categories'] = article.categories.map(&:name)
    attributes['filter'] = %w(erb textile)
    attributes['layout'] = 'blog'
    file.puts attributes.to_yaml
    file.puts "---"
    file.puts article.body
  end
  puts "#{index+1}/#{blog.articles.length}"
end

`tar cvf blog.tar tmp/blog/*`
