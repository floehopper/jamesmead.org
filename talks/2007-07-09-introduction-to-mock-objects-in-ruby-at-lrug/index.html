<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

  <title>An Introduction to Mock Objects in Ruby - James Mead</title>
  <!-- metadata -->
  <meta name="generator" content="S5" />
  <meta name="version" content="S5 1.1" />
  <meta name="presdate" content="20070709" />
  <meta name="author" content="James Mead" />
  <meta name="company" content="Floehopper Ltd" />
  <!-- configuration parameters -->
  <meta name="defaultView" content="slideshow" />
  <meta name="controlVis" content="hidden" />
  <!-- style sheet links -->
  <link rel="stylesheet" href="ui/default/slides.css" type="text/css" media="projection" id="slideProj" />
  <link rel="stylesheet" href="ui/default/outline.css" type="text/css" media="screen" id="outlineStyle" />
  <link rel="stylesheet" href="ui/default/print.css" type="text/css" media="print" id="slidePrint" />
  <link rel="stylesheet" href="ui/default/opera.css" type="text/css" media="projection" id="operaFix" />
  <!-- S5 JS -->
  <script src="ui/default/slides.js" type="text/javascript"></script>
</head>
<body>

<div class="layout">
  <div id="controls"><!-- DO NOT EDIT --></div>
  <div id="currentSlide"><!-- DO NOT EDIT --></div>
  <div id="header"></div>
  <div id="footer">
    <h1>LRUG, 9th July 2007</h1>
    <h2>An Introduction to Mock Objects in Ruby</h2>
  </div>
</div>

<div class="presentation">

    <div class="slide">
      <div class="content">
        <h1>An Introduction to Mock Objects in Ruby</h1>


	<p>James Mead</p>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Outline</h1>


	<ul>
	<li>What is a Mock Object?</li>
		<li>Why use Mock Objects?</li>
		<li>Examples using Mocha</li>
		<li>Hints and Tips</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Outline</h1>


	<ul>
	<li><span style="color:red;">What is a Mock Object?</span></li>
		<li>Why use Mock Objects?</li>
		<li>Examples using Mocha</li>
		<li>Hints and Tips</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>What is a Mock Object?</h1>


	<blockquote>
		<p>Years later, Mock objects are still quite controversial, often misused and sometimes misunderstood.</p>
	</blockquote>


	<p>&#8220;Pintside Thoughts: Mock Objects History&#8221;</p>


	<p>&#8212;Tim McKinnon</p>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>What is a Mock Object?</h1>


	<ul>
	<li>Different things to different people</li>
		<li>Ambiguous terminology</li>
		<li>Confusion with Rails &#8220;mocks&#8221; </li>
		<li>Learn from the Java &#38; <span class="caps">TDD</span> community</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Test Double</h1>


	<ul>
	<li><em>xUnit Test Patterns</em> (Gerard Meszaros)</li>
		<li>Think &#8220;stunt double&#8221; </li>
		<li>Replace production object for testing purposes</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li>Dummy Object</li>
		<li>Test Stub</li>
		<li>Test Spy</li>
		<li>Mock Object</li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li><span style="color:red;">Dummy Object</span></li>
		<li>Test Stub</li>
		<li>Test Spy</li>
		<li>Mock Object</li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Dummy Object</h1>


	<ul>
	<li>Trivial, placeholder</li>
		<li>No behaviour relevant to test</li>
		<li>e.g. <code class="syntax"><span class="constant">nil</span></code>, <code class="syntax"><span class="constant">Object</span><span class="punct">.</span><span class="ident">new</span></code></li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li>Dummy Object</li>
		<li><span style="color:red;">Test Stub</span></li>
		<li>Test Spy</li>
		<li>Mock Object</li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Test Stub</h1>


	<ul>
	<li>Canned return values</li>
		<li>May only respond to calls needed for test</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">Clock</span>

  <span class="keyword">def </span><span class="method">time</span>
    <span class="constant">Time</span><span class="punct">.</span><span class="ident">now</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">class </span><span class="class">Event</span>

  <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">start_time</span><span class="punct">)</span>
    <span class="attribute">@start_time</span> <span class="punct">=</span> <span class="ident">start_time</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">started?</span><span class="punct">(</span><span class="ident">clock</span> <span class="punct">=</span> <span class="constant">Clock</span><span class="punct">.</span><span class="ident">new</span><span class="punct">)</span>
    <span class="ident">clock</span><span class="punct">.</span><span class="ident">time</span> <span class="punct">&gt;</span> <span class="attribute">@start_time</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">StubClock</span>

  <span class="keyword">def </span><span class="method">time</span>
    <span class="constant">Time</span><span class="punct">.</span><span class="ident">parse</span><span class="punct">('</span><span class="string">2007-07-09 19:00</span><span class="punct">')</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">clock</span> <span class="punct">=</span> <span class="constant">StubClock</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">meeting</span> <span class="punct">=</span> <span class="constant">Event</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="constant">Time</span><span class="punct">.</span><span class="ident">parse</span><span class="punct">('</span><span class="string">2007-07-09 18:00</span><span class="punct">'))</span>
<span class="ident">pub</span> <span class="punct">=</span> <span class="constant">Event</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="constant">Time</span><span class="punct">.</span><span class="ident">parse</span><span class="punct">('</span><span class="string">2007-07-09 20:00</span><span class="punct">'))</span>

<span class="ident">assert_equal</span> <span class="constant">true</span><span class="punct">,</span> <span class="ident">meeting</span><span class="punct">.</span><span class="ident">started?</span><span class="punct">(</span><span class="ident">clock</span><span class="punct">)</span>
<span class="ident">assert_equal</span> <span class="constant">false</span><span class="punct">,</span> <span class="ident">pub</span><span class="punct">.</span><span class="ident">started?</span><span class="punct">(</span><span class="ident">clock</span><span class="punct">)</span> <span class="comment"># :-(</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li>Dummy Object</li>
		<li>Test Stub</li>
		<li><span style="color:red;">Test Spy</span></li>
		<li>Mock Object</li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Test Spy</h1>


	<ul>
	<li>Records method invocations</li>
		<li>Test makes assertions on Spy after the event</li>
		<li>May incorporate behaviour of Test Stub</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">Bell</span>

  <span class="keyword">def </span><span class="method">start_ringing</span>
    <span class="comment"># ring, ring</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">class </span><span class="class">Alarm</span>

  <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">bell</span> <span class="punct">=</span> <span class="constant">Bell</span><span class="punct">.</span><span class="ident">new</span><span class="punct">)</span>
    <span class="attribute">@bell</span> <span class="punct">=</span> <span class="ident">bell</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">trigger</span>
    <span class="attribute">@bell</span><span class="punct">.</span><span class="ident">start_ringing</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">BellSpy</span>

  <span class="ident">attr_reader</span> <span class="symbol">:number_of_calls</span>

  <span class="keyword">def </span><span class="method">initialize</span>
    <span class="attribute">@number_of_calls</span> <span class="punct">=</span> <span class="number">0</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">start_ringing</span>
    <span class="attribute">@number_of_calls</span> <span class="punct">+=</span> <span class="number">1</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">bell</span> <span class="punct">=</span> <span class="constant">BellSpy</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">alarm</span> <span class="punct">=</span> <span class="constant">Alarm</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">bell</span><span class="punct">)</span>
<span class="ident">alarm</span><span class="punct">.</span><span class="ident">trigger</span>

<span class="ident">assert_equal</span> <span class="number">1</span><span class="punct">,</span> <span class="ident">bell</span><span class="punct">.</span><span class="ident">number_of_calls</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li>Dummy Object</li>
		<li>Test Stub</li>
		<li>Test Spy</li>
		<li><span style="color:red;">Mock Object</span></li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mock Object</h1>


	<ul>
	<li>Expected method invocations set in advance</li>
		<li>Verifies actual invocations match expected ones</li>
		<li>May incorporate behaviour of Test Stub</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">Track</span>

  <span class="keyword">def </span><span class="method">move</span><span class="punct">(</span><span class="ident">steps</span><span class="punct">)</span>
    <span class="comment"># drive motor</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="keyword">class </span><span class="class">Tank</span>

  <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">left</span> <span class="punct">=</span> <span class="constant">Track</span><span class="punct">.</span><span class="ident">new</span><span class="punct">,</span> <span class="ident">right</span> <span class="punct">=</span> <span class="constant">Track</span><span class="punct">.</span><span class="ident">new</span><span class="punct">)</span>
    <span class="attribute">@left</span><span class="punct">,</span> <span class="attribute">@right</span> <span class="punct">=</span> <span class="ident">left</span><span class="punct">,</span> <span class="ident">right</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">turn_right</span>
    <span class="attribute">@left</span><span class="punct">.</span><span class="ident">move</span><span class="punct">(+</span><span class="number">5</span><span class="punct">)</span>
    <span class="attribute">@right</span><span class="punct">.</span><span class="ident">move</span><span class="punct">(-</span><span class="number">5</span><span class="punct">)</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">MockTrack</span>

  <span class="ident">include</span> <span class="constant">Test</span><span class="punct">::</span><span class="constant">Unit</span><span class="punct">::</span><span class="constant">Assertions</span>

  <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">expected_steps</span><span class="punct">)</span>
    <span class="attribute">@expected_steps</span> <span class="punct">=</span> <span class="ident">expected_steps</span>
    <span class="attribute">@actual_steps</span> <span class="punct">=</span> <span class="number">0</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">move</span><span class="punct">(</span><span class="ident">steps</span><span class="punct">)</span>
    <span class="attribute">@actual_steps</span> <span class="punct">+=</span> <span class="ident">steps</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">verify</span>
    <span class="ident">assert_equal</span> <span class="attribute">@expected_steps</span><span class="punct">,</span> <span class="attribute">@actual_steps</span>
  <span class="keyword">end</span>

<span class="keyword">end</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="ident">left_track</span> <span class="punct">=</span> <span class="constant">MockTrack</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(+</span><span class="number">5</span><span class="punct">)</span>
<span class="ident">right_track</span> <span class="punct">=</span> <span class="constant">MockTrack</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(-</span><span class="number">5</span><span class="punct">)</span>
<span class="ident">tank</span> <span class="punct">=</span> <span class="constant">Tank</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">left_track</span><span class="punct">,</span> <span class="ident">right_track</span><span class="punct">)</span>

<span class="ident">tank</span><span class="punct">.</span><span class="ident">turn_right</span>

<span class="ident">left_track</span><span class="punct">.</span><span class="ident">verify</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">verify</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li>Dummy Object</li>
		<li>Test Stub</li>
		<li>Test Spy</li>
		<li>Mock Object</li>
		<li><span style="color:red;">Fake Object</span></li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Fake Object</h1>


	<ul>
	<li>Mostly working implementation</li>
		<li>Lightweight, unsuitable for production</li>
		<li>e.g. in-memory database</li>
	</ul>
      </div>

        <div class="handout">
          <p>A Fake Object is can be used as if it were the real thing. It usually has better performance than the real thing by simplifying the implementation e.g. in-memory database is not actually persistent if its process is restarted, but it is persistent for the duration of the tests. A Fake Object also usually avoids unhelpful side effects e.g. actually emailing your customers to tell them you&#8217;ve billed them successfully.</p>


	<p>Rails &#8220;mocks&#8221; (i.e. where classes are re-opened in files in the test/mocks directory) often fall into this category.</p>
        </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Types of Test Doubles</h1>


	<ul>
	<li>Dummy Object</li>
		<li>Test Stub</li>
		<li>Test Spy</li>
		<li>Mock Object</li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Hard-coded or Configurable</h1>


	<ul>
	<li>Dummy Object</li>
		<li><span style="color:red;">Test Stub</span></li>
		<li><span style="color:red;">Test Spy</span></li>
		<li><span style="color:red;">Mock Object</span></li>
		<li>Fake Object</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Configurable Mock Object</h1>


	<ul>
	<li>Single generic Mock class</li>
		<li>Not multiple concrete Mock classes</li>
		<li>Test configures expected invocations</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="ident">left_track</span> <span class="punct">=</span> <span class="constant">Mock</span><span class="punct">.</span><span class="ident">new</span><span class="punct">('</span><span class="string">left_track</span><span class="punct">')</span>
<span class="ident">right_track</span> <span class="punct">=</span> <span class="constant">Mock</span><span class="punct">.</span><span class="ident">new</span><span class="punct">('</span><span class="string">right_track</span><span class="punct">')</span>
<span class="ident">tank</span> <span class="punct">=</span> <span class="constant">Tank</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">left_track</span><span class="punct">,</span> <span class="ident">right_track</span><span class="punct">)</span>

<span class="comment"># configure mock objects</span>
<span class="ident">left_track</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:move</span><span class="punct">).</span><span class="ident">with</span><span class="punct">(+</span><span class="number">5</span><span class="punct">)</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:move</span><span class="punct">).</span><span class="ident">with</span><span class="punct">(-</span><span class="number">5</span><span class="punct">)</span>

<span class="ident">tank</span><span class="punct">.</span><span class="ident">turn_right</span>

<span class="ident">left_track</span><span class="punct">.</span><span class="ident">verify</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">verify</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Record and Playback</h1>


	<ul>
	<li>Mock Object has two modes</li>
		<li>Record &#8211; test calls expected methods</li>
		<li>Playback &#8211; actual methods called</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="ident">left_track</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">left_track</span><span class="punct">')</span>
<span class="ident">right_track</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">right_track</span><span class="punct">')</span>
<span class="ident">tank</span> <span class="punct">=</span> <span class="constant">Tank</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">left_track</span><span class="punct">,</span> <span class="ident">right_track</span><span class="punct">)</span>

<span class="comment"># configure mock objects</span>
<span class="ident">left_track</span><span class="punct">.</span><span class="ident">move</span><span class="punct">(+</span><span class="number">5</span><span class="punct">)</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">move</span><span class="punct">(-</span><span class="number">5</span><span class="punct">)</span>

<span class="comment"># change to playback mode</span>
<span class="ident">left_track</span><span class="punct">.</span><span class="ident">replay</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">replay</span>

<span class="ident">tank</span><span class="punct">.</span><span class="ident">turn_right</span>

<span class="ident">left_track</span><span class="punct">.</span><span class="ident">verify</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">verify</span></pre>
      </div>

        <div class="handout">
          <p>The configuration stage looks quite nice, because you actually call methods on the mock in record mode to indicate what you are expecting. However, I think you lose an element of double-entry book-keeping &#8211; in that the test can look almost exactly the same as the implementation.
Also it&#8217;s not always quite as elegant as it looks in this example, because you might also need to specify return values &#8211; EasyMock does this using a setReturnValue method.</p>
        </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Outline</h1>


	<ul>
	<li>What is a Mock Object?</li>
		<li><span style="color:red;">Why use Mock Objects?</span></li>
		<li>Examples using Mocha</li>
		<li>Hints and Tips</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>If everything&#8217;s mocked, what&#8217;s actually being tested?</h1>


	<ul>
	<li>Mocks are most useful for unit testing</li>
		<li>Integration tests demonstrate actual collaboration</li>
		<li>Fake objects are more useful in integration tests</li>
	</ul>
      </div>

        <div class="handout">
          <p>This is a question that gets asked a lot. Mock Objects are most useful in testing a single class in isolation, helping you focus on testing the behaviour of just that one class. That one class is the real implementation not a mock &#8211; so not everything is mocked.</p>


	<p>However, it&#8217;s right to be concerned that these unit tests do not guarantee that the system will behave how you expect. For that you need integration/acceptance tests which don&#8217;t use Mock Objects and which check that the real objects collaborate correctly.</p>


	<p>I&#8217;d suggest it&#8217;s best to aim for high test coverage in your unit tests, but focus test coverage in your integration/acceptance tests on critical business scenarios. This is because unit tests run fast and failures in unit tests are more easily diagnosed.</p>
        </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Behaviour vs State Verification</h1>


	<ul>
	<li>Behaviour &#8211; test interactions between objects</li>
		<li>State &#8211; test results of those interactions</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="ident">left_track</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">left_track</span><span class="punct">')</span>
<span class="ident">right_track</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">right_track</span><span class="punct">')</span>
<span class="ident">tank</span> <span class="punct">=</span> <span class="constant">Tank</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">left_track</span><span class="punct">,</span> <span class="ident">right_track</span><span class="punct">)</span>

<span class="ident">left_track</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:move</span><span class="punct">).</span><span class="ident">with</span><span class="punct">(+</span><span class="number">5</span><span class="punct">)</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:move</span><span class="punct">).</span><span class="ident">with</span><span class="punct">(-</span><span class="number">5</span><span class="punct">)</span>

<span class="ident">tank</span><span class="punct">.</span><span class="ident">turn_right</span>

<span class="comment"># behaviour verification</span>
<span class="ident">left_track</span><span class="punct">.</span><span class="ident">verify</span>
<span class="ident">right_track</span><span class="punct">.</span><span class="ident">verify</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="ident">tank</span> <span class="punct">=</span> <span class="constant">Tank</span><span class="punct">.</span><span class="ident">new</span>

<span class="ident">initial_left_track_position</span> <span class="punct">=</span> <span class="ident">tank</span><span class="punct">.</span><span class="ident">left_track</span><span class="punct">.</span><span class="ident">position</span>
<span class="ident">initial_right_track_position</span> <span class="punct">=</span> <span class="ident">tank</span><span class="punct">.</span><span class="ident">right_track</span><span class="punct">.</span><span class="ident">position</span>

<span class="ident">tank</span><span class="punct">.</span><span class="ident">turn_right</span>

<span class="comment"># state verification</span>
<span class="ident">assert_equal</span> <span class="punct">+</span><span class="number">5</span><span class="punct">,</span> <span class="ident">tank</span><span class="punct">.</span><span class="ident">left_track</span><span class="punct">.</span><span class="ident">position</span> <span class="punct">-</span> <span class="ident">initial_left_track_position</span>
<span class="ident">assert_equal</span> <span class="punct">-</span><span class="number">5</span><span class="punct">,</span> <span class="ident">tank</span><span class="punct">.</span><span class="ident">right_track</span><span class="punct">.</span><span class="ident">position</span> <span class="punct">-</span> <span class="ident">initial_right_track_position</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Why use Mock Objects?</h1>


	<ul>
	<li>Less interaction with e.g database</li>
		<li>No need to unnecessarily expose state</li>
		<li>Less duplicate coverage</li>
		<li>Faster tests</li>
		<li>Reduced coupling</li>
		<li>Enhanced <span class="caps">TDD</span></li>
	</ul>
      </div>

        <div class="handout">
          <p>Using Mock Objects in unit tests allows us to completely isolate object under test. A unit test for a specific class should be decoupled from the implementation of any of that class&#8217;s collaborators.</p>


	<p>The Law of Demeter which basically says &#8220;only talk to your immediate friends&#8221; suggests that its a bad idea to unnecessarily expose object state.</p>


	<p>Doing test-driven development using Mock Objects, you can drive out the public interface you need for an object before you&#8217;ve implemented it.</p>
        </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Ruby Mock Object Libraries</h1>


	<ul>
	<li>Mocha</li>
		<li>RSpec Mocks</li>
		<li>Flexmock</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mocha</h1>


	<ul>
	<li>Harvested from projects at Reevoo</li>
		<li>Ben Griffiths, Chris Roos &#38; Paul Battley</li>
		<li>Simple, readable syntax inspired by JMock</li>
		<li>Unified syntax for traditional &#38; partial mocking</li>
		<li>Pronounced Mokker not Moker</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Outline</h1>


	<ul>
	<li>What is a Mock Object?</li>
		<li>Why use Mock Objects?</li>
		<li><span style="color:red;">Examples using Mocha</span></li>
		<li>Hints and Tips</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mocha Examples</h1>


	<ul>
	<li>Traditional Mocking</li>
		<li>Partial Mocking</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mocha Examples</h1>


	<ul>
	<li><span style="color:red;">Traditional Mocking</span></li>
		<li>Partial Mocking</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># expect instance method</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">duck</span><span class="punct">')</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:quack</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">quack</span>

<span class="comment"># =&gt; verify success</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># expect multiple invocations</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">duck</span><span class="punct">')</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:quack</span><span class="punct">).</span><span class="ident">times</span><span class="punct">(</span><span class="number">3</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">quack</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">quack</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">quack</span>

<span class="comment"># =&gt; verify success</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># specifying parameters</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">duck</span><span class="punct">')</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:waddle</span><span class="punct">).</span><span class="ident">with</span><span class="punct">(</span><span class="number">2</span><span class="punct">.</span><span class="ident">metres</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">waddle</span><span class="punct">(</span><span class="number">1</span><span class="punct">.</span><span class="ident">metre</span><span class="punct">)</span>

<span class="comment"># =&gt; verify failure</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># specifying some parameters</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">duck</span><span class="punct">')</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">expects</span><span class="punct">(</span><span class="symbol">:swim</span><span class="punct">).</span><span class="ident">with</span><span class="punct">(</span><span class="ident">anything</span><span class="punct">,</span> <span class="number">1</span><span class="punct">.</span><span class="ident">metre_per_second</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">swim</span><span class="punct">(</span><span class="number">2</span><span class="punct">.</span><span class="ident">metres</span><span class="punct">,</span> <span class="number">1</span><span class="punct">.</span><span class="ident">metre_per_second</span><span class="punct">)</span>

<span class="comment"># =&gt; verify success</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># return values and exceptions</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">duck</span><span class="punct">')</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:flap_wings</span><span class="punct">).</span><span class="ident">returns</span><span class="punct">(</span><span class="constant">true</span><span class="punct">,</span><span class="constant">true</span><span class="punct">,</span><span class="constant">true</span><span class="punct">).</span><span class="ident">then</span><span class="punct">.</span><span class="ident">raises</span><span class="punct">(</span><span class="constant">BrokenWingError</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">flap_wings</span> <span class="comment"># =&gt; true</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">flap_wings</span> <span class="comment"># =&gt; true</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">flap_wings</span> <span class="comment"># =&gt; true</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">flap_wings</span> <span class="comment"># =&gt; raises BrokenWingError</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># shortcuts</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">stub</span><span class="punct">(</span><span class="symbol">:animal?</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">,</span> <span class="symbol">:bird?</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">animal?</span> <span class="comment"># =&gt; true</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">bird?</span>   <span class="comment"># =&gt; true</span>

<span class="ident">duck</span> <span class="punct">=</span> <span class="ident">stub_everything</span><span class="punct">(</span><span class="symbol">:bird?</span> <span class="punct">=&gt;</span> <span class="constant">true</span><span class="punct">)</span>

<span class="ident">duck</span><span class="punct">.</span><span class="ident">animal?</span>  <span class="comment"># =&gt; nil</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">mineral?</span> <span class="comment"># =&gt; nil</span>
<span class="ident">duck</span><span class="punct">.</span><span class="ident">bird?</span>    <span class="comment"># =&gt; true</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mocha Examples</h1>


	<ul>
	<li>Traditional Mocking</li>
		<li><span style="color:red;">Partial Mocking</span></li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># stubbing instance method</span>

<span class="ident">donald</span> <span class="punct">=</span> <span class="constant">Duck</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">donald</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:flap_wings</span><span class="punct">).</span><span class="ident">returns</span><span class="punct">(</span><span class="constant">true</span><span class="punct">)</span>

<span class="ident">daffy</span> <span class="punct">=</span> <span class="constant">Duck</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">daffy</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:flap_wings</span><span class="punct">).</span><span class="ident">raises</span><span class="punct">(</span><span class="constant">BrokenWingError</span><span class="punct">)</span>

<span class="ident">donald</span><span class="punct">.</span><span class="ident">flap_wings</span> <span class="comment"># =&gt; true</span>
<span class="ident">daffy</span><span class="punct">.</span><span class="ident">flap_wings</span> <span class="comment"># =&gt; raises BrokenWingError</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># stubbing class method</span>

<span class="constant">Duck</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:animal?</span><span class="punct">).</span><span class="ident">returns</span><span class="punct">(</span><span class="constant">false</span><span class="punct">)</span>

<span class="comment"># stubbed implementation</span>

<span class="constant">Duck</span><span class="punct">.</span><span class="ident">animal?</span> <span class="comment"># =&gt; false</span>

<span class="comment"># original implementation unchanged</span>

<span class="constant">Duck</span><span class="punct">.</span><span class="ident">animal?</span> <span class="comment"># =&gt; true</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="comment"># stubbing instance method on any instance of a class</span>

<span class="ident">daisy</span> <span class="punct">=</span> <span class="constant">Duck</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">daisy</span><span class="punct">.</span><span class="ident">bird?</span> <span class="comment"># =&gt; true # original implementation</span>

<span class="constant">Duck</span><span class="punct">.</span><span class="ident">any_instance</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:bird?</span><span class="punct">).</span><span class="ident">returns</span><span class="punct">(</span><span class="constant">false</span><span class="punct">)</span>

<span class="ident">daffy</span> <span class="punct">=</span> <span class="constant">Duck</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">daffy</span><span class="punct">.</span><span class="ident">bird?</span> <span class="comment"># =&gt; false</span>

<span class="ident">donald</span> <span class="punct">=</span> <span class="constant">Duck</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">donald</span><span class="punct">.</span><span class="ident">bird?</span> <span class="comment"># =&gt; false</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Outline</h1>


	<ul>
	<li>What is a Mock Object?</li>
		<li>Why use Mock Objects?</li>
		<li>Examples using Mocha</li>
		<li><span style="color:red;">Hints and Tips</span></li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mock Injection</h1>


	<ul>
	<li>Method or constructor parameter (default value)</li>
		<li>Writer method i.e. <code class="syntax"><span class="ident">attr_writer</span></code></li>
		<li>Stub <code class="syntax"><span class="ident">new</span></code> method on class</li>
		<li>Stubbed method (private)</li>
		<li>Stub methods using <code class="syntax"><span class="ident">any_instance</span></code></li>
		<li>Use <code class="syntax"><span class="ident">instance_variable_set</span></code></li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="keyword">def </span><span class="method">initialize</span><span class="punct">(</span><span class="ident">dependency</span> <span class="punct">=</span> <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span><span class="punct">)</span>
    <span class="attribute">@dependency</span> <span class="punct">=</span> <span class="ident">dependency</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">do_something</span>
    <span class="comment"># use @dependency</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">collaborator</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">collaborator</span><span class="punct">')</span>
<span class="comment"># constructor parameter injection</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span><span class="punct">(</span><span class="ident">collaborator</span><span class="punct">)</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="keyword">def </span><span class="method">do_something</span><span class="punct">(</span><span class="ident">local_dependency</span> <span class="punct">=</span> <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span><span class="punct">)</span>
    <span class="comment"># use local_dependency</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">collaborator</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">collaborator</span><span class="punct">')</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span>
<span class="comment"># method parameter injection</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span><span class="punct">(</span><span class="ident">collaborator</span><span class="punct">)</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="ident">attr_writer</span> <span class="symbol">:dependency</span>

  <span class="keyword">def </span><span class="method">initialize</span>
    <span class="attribute">@dependency</span> <span class="punct">=</span> <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">do_something</span>
    <span class="comment"># use @dependency</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">collaborator</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">collaborator</span><span class="punct">')</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span>
<span class="comment"># writer method injection</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">dependency</span> <span class="punct">=</span> <span class="ident">collaborator</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="keyword">def </span><span class="method">initialize</span>
    <span class="attribute">@dependency</span> <span class="punct">=</span> <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">do_something</span>
    <span class="comment"># use @dependency</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">collaborator</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">collaborator</span><span class="punct">')</span>
<span class="comment"># stubbed new method injection</span>
<span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:new</span><span class="punct">).</span><span class="ident">returns</span><span class="punct">(</span><span class="ident">collaborator</span><span class="punct">)</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="keyword">def </span><span class="method">do_something</span>
    <span class="ident">local_dependency</span> <span class="punct">=</span> <span class="ident">build_collaborator</span><span class="punct">()</span>
    <span class="comment"># use local_dependency</span>
  <span class="keyword">end</span>

  <span class="ident">private</span>

  <span class="keyword">def </span><span class="method">build_collaborator</span>
    <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="ident">collaborator</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">collaborator</span><span class="punct">')</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span>
<span class="comment"># stubbed private method injection</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:build_collaborator</span><span class="punct">).</span><span class="ident">returns</span><span class="punct">(</span><span class="ident">collaborator</span><span class="punct">)</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="keyword">def </span><span class="method">do_something</span>
    <span class="ident">local_dependency</span> <span class="punct">=</span> <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span>
    <span class="keyword">return</span> <span class="ident">local_dependency</span><span class="punct">.</span><span class="ident">do_stuff</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>

<span class="comment"># any_instance stub injection</span>
<span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">any_instance</span><span class="punct">.</span><span class="ident">stubs</span><span class="punct">(</span><span class="symbol">:do_stuff</span><span class="punct">).</span><span class="ident">return</span><span class="punct">('</span><span class="string">something useful</span><span class="punct">')</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <pre class="syntax"><span class="keyword">class </span><span class="class">ClassUnderTest</span>

  <span class="keyword">def </span><span class="method">initialize</span>
    <span class="attribute">@dependency</span> <span class="punct">=</span> <span class="constant">Collaborator</span><span class="punct">.</span><span class="ident">new</span>
  <span class="keyword">end</span>

  <span class="keyword">def </span><span class="method">do_something</span>
    <span class="comment"># use @dependency</span>
  <span class="keyword">end</span>

<span class="keyword">end</span>


<span class="ident">collaborator</span> <span class="punct">=</span> <span class="ident">mock</span><span class="punct">('</span><span class="string">collaborator</span><span class="punct">')</span>
<span class="ident">instance_under_test</span> <span class="punct">=</span> <span class="constant">ClassUnderTest</span><span class="punct">.</span><span class="ident">new</span>
<span class="comment"># instance_variable_set injection</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">instance_variable_set</span><span class="punct">(</span><span class="symbol">:@dependency</span><span class="punct">,</span> <span class="ident">collaborator</span><span class="punct">)</span>
<span class="ident">instance_under_test</span><span class="punct">.</span><span class="ident">do_something</span></pre>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Command vs Query</h1>


	<ul>
	<li>Command method
	<ul>
	<li>changes an object&#8217;s state</li>
		<li>returns at most indication of success/failure</li>
	</ul>
	</li>
		<li>Query method
	<ul>
	<li>does not change an object&#8217;s state</li>
		<li>returns an aspect of object&#8217;s state</li>
	</ul>
	</li>
		<li>Expect commands, stub queries</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Mocking External Services</h1>


	<ul>
	<li>Don&#8217;t attempt to mock directly</li>
		<li>Wrap them with an application-specific adapter</li>
		<li>Mock the adapter</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>Fragile Tests</h1>


	<ul>
	<li>Avoid one-for-one matching of expectation &#38; code</li>
		<li>Minimally constrain the code under test</li>
		<li>Don&#8217;t expect when you could stub</li>
		<li>Specify range instead of exact value</li>
	</ul>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>The End</h1>


	<ul>
	<li>You can play with yourself</li>
		<li>You can play with your own toys</li>
		<li>You can play with toys that were given to you</li>
		<li>And you can play with toys you&#8217;ve made yourself</li>
	</ul>


	<p>Source: C2 Wiki &#8211; Law of Demeter</p>
      </div>

    </div>

    <div class="slide">
      <div class="content">
        <h1>References</h1>


	<ul>
	<li>Mock Objects (http://www.mockobjects.com)</li>
		<li>xUnit Test Patterns (http://xunitpatterns.com)</li>
		<li>JMock (http://www.jmock.org)</li>
		<li>Martin Fowler (http://www.martinfowler.com)</li>
	</ul>
      </div>

    </div>

</div>

</body>
</html>
