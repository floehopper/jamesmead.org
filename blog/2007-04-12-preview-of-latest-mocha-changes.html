<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Preview of Latest Mocha Changes - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="keywords" content="ruby mocha preview mock stub return raise yield" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js" defer="defer"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2007-04-05-cruisecontrol-rb-for-mocha" />
    <link rel="next" href="/blog/2007-04-25-escape-from-the-enterprise-london-rails-jobs" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-05-18-how-to-backup-google-drive-to-s3-using-the-aws-cdk" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2007-04-12-preview-of-latest-mocha-changes" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">Preview of Latest Mocha Changes</h1>
    </header>

    <section class="e-content">
      <p>I&#8217;ve finally managed to find some time to do some serious work on <a href="https://mocha.jamesmead.org/">Mocha</a>. Here are some code snippets showing the new functionality available in trunk (revision 128). I don&#8217;t don&#8217;t know how many people out there are using trunk, but it would be great to get some feedback on these changes before I make a new release. In particular I&#8217;d like to know whether&#8230;</p>
<ul>
	<li>I&#8217;ve broken anybody&#8217;s tests.</li>
	<li>Anybody has a legitimate use for <code>parameter_block</code> in <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000017"><code>Expectation#with</code></a> that they don&#8217;t think will be handled by a suitable parameter matcher i.e. using the current behaviour where the block is passed the parameters and the result of the block determines whether the expectation matches. I&#8217;m planning on deprecating this soon.</li>
	<li>Anybody has a legitimate use for passing in an instance of <code>Proc</code> to <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000019"><code>Expectation#returns</code></a> i.e. using the current behaviour where the <code>Proc</code> gets executed to generate a return value. I&#8217;m planning on deprecating this soon as well.</li>
</ul>
<p>I&#8217;ve typed this up in a bit of a rush (about to go on holiday for a few days), so apologies if there are any mistakes.</p>
<h2>Parameter Matchers</h2>
<p>I&#8217;ve added a few <a href="http://code.google.com/p/hamcrest/wiki/Tutorial">Hamcrest-style</a> parameter matchers which are designed to be used inside <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000017"><code>Expectation#with</code></a>. The following matchers are currently available: has_key(), has_value() &amp; has_entry(). More to follow soon. The idea is eventually to get rid of the nasty <code>parameter_block</code> option on <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000017"><code>Expectation#with</code></a>.</p>
<pre class="prettyprint"><code class="prettyprint">object = mock()
object.expects(:method).with(has_key('key_1'))
object.method('key_1' =&gt; 1, 'key_2' =&gt; 2)
# no verification error raised</code></pre>
<pre class="prettyprint"><code class="prettyprint">object = mock()
object.expects(:method).with(has_key('key_1'))
object.method('key_2' =&gt; 2)
# verification error raised, because method was not called with Hash containing key: 'key_1'</code></pre>
<h2>Values Returned and Exceptions Raised on Consecutive Invocations</h2>
<p>Allow multiple calls to <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000019"><code>Expectation#returns</code></a> and <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000020"><code>Expectation#raises</code></a> to build up a sequence of responses to invocations on the mock. Added syntactic sugar method <code>Expectation#then</code> to allow more readable expectations.</p>
<pre class="prettyprint"><code class="prettyprint">object = mock()
object.stubs(:method).returns(1, 2).then.raises(Exception).then.returns(4)
object.method # =&gt; 1
object.method # =&gt; 2
object.method # =&gt; raises exception of class Exception
object.method # =&gt; 4</code></pre>
<h2>Yields on Consecutive Invocations</h2>
<p>Allow multiple calls to yields on single expectation to allow yield parameters to be specified for consecutive invocations.</p>
<pre class="prettyprint"><code class="prettyprint">object = mock()
object.stubs(:method).yields(1, 2).then.yields(3)
object.method { |*values| p values } # =&gt; [1, 2]
object.method { |*values| p values } # =&gt; [3]</code></pre>
<h2>Multiple Yields on Single Invocation</h2>
<p>Added <code>Expectation#multiple_yields</code> to allow a mocked or stubbed method to yield multiple times for a single invocation.</p>
<pre class="prettyprint"><code class="prettyprint">object = mock()
object.stubs(:method).multiple_yields([1, 2], [3])
object.method { |*values| p values } # =&gt; [1, 2] # =&gt; [3]</code></pre>
<h2>Invocation Dispatch</h2>
<p>Expectations were already being matched in reverse order i.e. the most recently defined one was being found first. This is still the case, but we now stop matching an expectation when its maximum number of expected invocations is reached. c.f. <a href="http://www.jmock.org/jmock1-dispatch.html">JMock v1</a>. A stub will never stop matching by default. Hopefully this means we can soon get rid of the need to pass a <code>Proc</code> to <a href="https://web.archive.org/web/20070524053033/http://mocha.rubyforge.org/classes/Mocha/Expectation.html#M000019"><code>Expectation#returns</code></a>.</p>
<pre class="prettyprint"><code class="prettyprint">object = mock()
object.stubs(:method).returns(2)
object.expects(:method).once.returns(1)
object.method # =&gt; 1
object.method # =&gt; 2
object.method # =&gt; 2
# no verification error raised</code></pre>
<p>This should still work&#8230;</p>
<pre class="prettyprint"><code class="prettyprint">Time.stubs(:now).returns(Time.parse('Mon Jan 01 00:00:00 UTC 2007'))
Time.now # =&gt; Mon Jan 01 00:00:00 UTC 2007
Time.stubs(:now).returns(Time.parse('Thu Feb 01 00:00:00 UTC 2007'))
Time.now # =&gt; Thu Feb 01 00:00:00 UTC 2007</code></pre>
<h2>Acknowledgements</h2>
<p>Thanks to David Chelimsky, Dan North, Jay Fields, Kevin Clark, Frederick Cheung, James Moore, Brian Helmkamp, Ben Griffiths, Chris Roos &amp; Paul Battley for their input. Apologies to anybody I forgot to mention.</p>
    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2007-04-12-preview-of-latest-mocha-changes"><time class="dt-published" datetime="2007-04-12T12:13:39+00:00">12 Apr 2007 at 12:13</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2007-04-12-preview-of-latest-mocha-changes">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8" defer></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2007-04-05-cruisecontrol-rb-for-mocha" class="previous">&lt; CruiseControl.rb for Mocha</a>
      <a href="/blog/2007-04-25-escape-from-the-enterprise-london-rails-jobs" class="next">Escape from the Enterprise - London Rails Jobs &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav style="float: left" aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <div style="float: right">
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/previous">‚Üê</a>
          An IndieWeb Webring üï∏üíç
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/next">‚Üí</a>
        </div>
        <p style="clear: both" xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">
          This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under
          <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons logo" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons Attribution icon" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons ShareAlike icon" />
          </a>
        </p>
      </footer>
    </div>
  </body>
</html>
