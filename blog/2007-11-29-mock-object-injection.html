<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Mock Object Injection - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="keywords" content="ruby mock object dependency injection collaborator testing" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js" defer="defer"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2007-11-08-changing-gner-advance-single-tickets-reply" />
    <link rel="next" href="/blog/2008-01-04-more-gner-nxec-advance-single-tickets-shenanigans" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-05-18-how-to-backup-google-drive-to-s3-using-the-aws-cdk" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2007-11-29-mock-object-injection" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/adventures/">Adventures</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">Mock Object Injection</h1>
    </header>

    <section class="e-content">
      <p>A few months back, in my <a href="/talks/2007-07-09-introduction-to-mock-objects-in-ruby-at-lrug/">Introduction to Mock Objects talk</a> at <a href="http://lrug.org">LRUG</a>, I talked about &#8220;Mock Object Injection&#8221;. At the time I described a number of different ways of replacing a production object with a <a href="http://www.mockobjects.com">Mock Object</a> using <a href="https://mocha.jamesmead.org/">Mocha</a>. I remember that at <a href="http://lrug.org/meetings/2007/06/20/july-2007-meeting/">the meeting</a>, <a href="http://interblah.net/">James Adam</a> (who has since joined the team at <a href="http://www.reevoo.com">Reevoo</a>) asked me why I didn&#8217;t like the <a href="#any-instance-stub-injection">Any Instance Stub Injection</a> technique.</p>
<p>I&#8217;m not sure I gave him a very convincing response and I&#8217;ve been meaning for ages to have a better go at explaining what I think are the pros and cons of each of the techniques I mentioned. Here&#8217;s the list of techniques with the ones I like best at the top. I still haven&#8217;t done a very good job, but I&#8217;d be interested to hear what other people think so that I can try and improve my understanding.</p>
<h2 id="constructor-injection">Constructor Injection</h2>
<p>The <code>ClassUnderTest</code> allows its dependencies to be passed in as parameters to its constructor. A mock object is passed in as a replacement for the &#8220;real&#8221; collaborator. It may be convenient to specify the production collaborator as a default parameter value.</p>
<h3>Advantages</h3>
<p>The dependencies of the <code>ClassUnderTest</code> are explicit.</p>
<h3>Disadvantages</h3>
<p>Can&#8217;t think of any at the moment.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  def initialize(dependency = Collaborator.new)
    @dependency = dependency
  end
  def do_something
    # use @dependency
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint">collaborator = mock('collaborator')
# constructor parameter injection
instance_under_test = ClassUnderTest.new(collaborator)
instance_under_test.do_something</code></pre>
<h2 id="parameter-injection">Parameter Injection</h2>
<p>The <code>ClassUnderTest</code> allows its dependencies to be passed in as parameters to the method under test. A mock object is passed in as a replacement for the &#8220;real&#8221; collaborator. It may be convenient to specify the production collaborator as a default parameter value.</p>
<h3>Advantages</h3>
<p>The dependencies of the method under test are explicit.</p>
<h3>Disadvantages</h3>
<p>Can&#8217;t think of any at the moment.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  def do_something(local_dependency = Collaborator.new)
    # use local_dependency
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint">collaborator = mock('collaborator')
instance_under_test = ClassUnderTest.new
# method parameter injection
instance_under_test.do_something(collaborator)</code></pre>
<h2 id="stubbed-new-method-injection">Stubbed New Method Injection</h2>
<p>Use Mocha&#8217;s <a href="https://web.archive.org/web/20080127102525/http://mocha.rubyforge.org/classes/Object.html#M000003">Object#stubs</a> to temporarily replace <code>Collaborator#new</code> with a stub implementation that returns a mock object.</p>
<h3>Advantages</h3>
<p>Better than <a href="#any-instance-stub-injection">Any Instance Stub Injection</a>, because you can have more control over different instances of <code>Collaborator</code>.</p>
<h3>Disadvantages</h3>
<p>Dependencies of the <code>ClassUnderTest</code> are hidden and not explicit.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  def initialize
    @dependency = Collaborator.new
  end
  def do_something
    # use @dependency
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint">collaborator = mock('collaborator')
# stubbed new method injection
Collaborator.stubs(:new).returns(collaborator)
instance_under_test = ClassUnderTest.new
instance_under_test.do_something</code></pre>
<h2 id="writer-method-injection">Writer Method Injection</h2>
<p>Use an attribute writer method to replace the &#8220;real&#8221; collaborator with a mock object.</p>
<h3>Disadvantages</h3>
<p>The <code>ClassUnderTest</code> has to unnecessarily expose a way to modify its internal state. The test is coupled to the implementation of the <code>ClassUnderTest</code>.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  attr_writer :dependency
  def initialize
    @dependency = Collaborator.new
  end
  def do_something
    # use @dependency
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint">collaborator = mock('collaborator')
instance_under_test = ClassUnderTest.new
# writer method injection
instance_under_test.dependency = collaborator
instance_under_test.do_something</code></pre>
<h2 id="stubbed-private-method-injection">Stubbed Private Method Injection</h2>
<p>Use <em>partial mocking</em> to temporarily replace a private builder method with a stubbed version of the method.</p>
<h3>Disadvantages</h3>
<p>The test is coupled to the implementation of the <code>ClassUnderTest</code>. The partial mocking of the <code>instance_under_test</code> means that the test is not testing a pristine instance of the <code>ClassUnderTest</code>, but a modified one. It also means that the boundaries between test code and production code are less clear.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  def do_something
    local_dependency = build_collaborator()
    # use local_dependency
  end
  private
  def build_collaborator
    Collaborator.new
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint">collaborator = mock('collaborator')
instance_under_test = ClassUnderTest.new
# stubbed private method injection
instance_under_test.stubs(:build_collaborator).returns(collaborator)
instance_under_test.do_something</code></pre>
<h2 id="any-instance-stub-injection">Any Instance Stub Injection</h2>
<p>Use Mocha&#8217;s <a href="https://web.archive.org/web/20080215232318/http://mocha.rubyforge.org/classes/Class.html#M000001">Class#any_instance</a> method to temporarily replace the method on a collaborator with a stub method.</p>
<h3>Disadvantages</h3>
<p>The stubbed method is applied to <strong>all</strong> instances of the collaborating class. If the <code>instance_under_test</code> interacts with the stubbed method on more than one instance of the collaborating class, it isn&#8217;t possible to specify different behaviour for the stubbed method on each instance. Even if the <code>instance_under_test</code> only interacts with the stubbed method on one instance of the collaborating class, the test is specifying more stubbed behaviour than strictly necessary which could lead to false positives.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  def do_something
    local_dependency = Collaborator.new
    return local_dependency.do_stuff
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint"># any_instance stub injection
Collaborator.any_instance.stubs(:do_stuff).return('something useful')
instance_under_test = ClassUnderTest.new
instance_under_test.do_something</code></pre>
<h2 id="instance-variable-set-injection">Instance Variable Set Injection</h2>
<p>Use <a href="http://www.ruby-doc.org/core/classes/Object.html#M000366"><code>Object#instance_variable_set</code></a> to replace the reference to a collaborator with a mock object.</p>
<h3>Disadvantages</h3>
<p>The test is coupled to the implementation of the <code>ClassUnderTest</code>. In particular the test is coupled to the supposedly private instance variable. In my opinion, it would be more honest to expose the instance variable by adding an attribute writer and using <a href="#writer-method-injection">Writer Method Injection</a>.</p>
<pre class="prettyprint"><code class="prettyprint">class ClassUnderTest
  def initialize
    @dependency = Collaborator.new
  end
  def do_something
    # use @dependency
  end
end</code></pre>
<pre class="prettyprint"><code class="prettyprint">collaborator = mock('collaborator')
instance_under_test = ClassUnderTest.new
# instance_variable_set injection
instance_under_test.instance_variable_set(:@dependency, collaborator)
instance_under_test.do_something
</code></pre>
    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2007-11-29-mock-object-injection"><time class="dt-published" datetime="2007-11-29T12:17:48+00:00">29 Nov 2007 at 12:17</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2007-11-29-mock-object-injection">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8" defer></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2007-11-08-changing-gner-advance-single-tickets-reply" class="previous">&lt; Changing GNER Advance Single tickets (reply)</a>
      <a href="/blog/2008-01-04-more-gner-nxec-advance-single-tickets-shenanigans" class="next">More GNER/NXEC Advance Single tickets shenanigans &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <div id="indieweb-ring">
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/previous">‚Üê</a>
          An IndieWeb Webring üï∏üíç
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/next">‚Üí</a>
        </div>
        <p id="creative-commons" xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">
          This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under
          <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons logo" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons Attribution icon" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons ShareAlike icon" />
          </a>
        </p>
      </footer>
    </div>
  </body>
</html>
