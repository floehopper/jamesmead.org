<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Generating and running a Rails app with PostgreSQL using Nix on Ubuntu - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Isolating a Nix environment by running on an Ubuntu VM provisioned by Vagrant" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell" />
    <link rel="next" href="/blog/2020-10-13-sending-webmentions-from-a-static-website" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-05-18-how-to-backup-google-drive-to-s3-using-the-aws-cdk" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2020-10-12-generating-and-running-a-rails-app-with-postgresql-using-nix-on-ubuntu" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">Generating and running a Rails app with PostgreSQL using Nix on Ubuntu</h1>
        <h2 class="p-summary">Isolating a Nix environment by running on an Ubuntu VM provisioned by Vagrant</h2>
    </header>

    <section class="e-content">
      <p>In my first attempt at setting up <a href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell">a simple Ruby development environment</a>, I was quite careful to make sure the Nix shell environment wasn't accidentally relying on anything available from the underlying environment. In particular, I noticed that unless I specifically added <code>nodejs</code> to the list of <code>buildInputs</code>, middleman ended up using the Node version in the <em>underlying</em> MacOS environment.</p>

<p>However, in my second attempt where I set up <a href="/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell">a simple Rails development environment</a>, I wasn't so careful and <a href="/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell#runtime-dependencies-update">I didn't do the same checks on the run-time dependencies</a>.</p>

<h3 id="ubuntu-vm-on-vagrant">Ubuntu VM on Vagrant</h3>

<p>Previously, in order to ensure full isolation, I ended up editing my "dot" files and even modifying environment variables in the current shell, but this was fiddly and error prone. So this time I decided to setup a completely seperate VM running Ubuntu Xenial (with minimal OS packages) using Vagrant to continue with my Nix experiments.</p>

<p>Furthermore I decided to try to write a provisioning script for the Vagrant configuration to create a new Rails app from scratch and to complete all the steps necessary for getting both the Rails tests and the Rails server running. By doing it this way, I could easily snapshot the VM and restore the snapshot or even destroy the VM and build it again to get back to a clean slate. I found this a really productive way to tackle the problem.</p>

<h3 id="installing-nix">Installing Nix</h3>

<p>First I had to install Nix on the Ubuntu VM. I used the <a href="https://nixos.org/manual/nix/stable/#sect-multi-user-installation">Nix multi-user installation instructions</a> to write an inline provisioning script in the <code>Vagrantfile</code> and I even worked out how to make the script idempotent:</p>

<pre><code>nix --version
if [ $? -eq 0 ]; then
  echo 'nix is already installed (skipping installation)'
else
  sh &lt;(curl -L https://nixos.org/nix/install) --daemon
fi
</code></pre>

<h3 id="generating-a-new-rails-app">Generating a new Rails app</h3>

<p>Next I created a nix-shell configuration that made the Rails gem specified by the "outer" <code>Gemfile</code> available:</p>

<pre><code>nix-shell -p ruby_2_6 bundler bundix --run 'bundle lock &amp;&amp; bundix --init --ruby=ruby_2_6'
</code></pre>

<p>Much like in my <a href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell">previous article</a>, this generated the following files in the "outer" directory:</p>

<ul>
  <li><code>Gemfile.lock</code></li>
  <li><code>gemset.nix</code></li>
  <li><code>shell.nix</code></li>
</ul>

<p>Now that this nix-shell specified by <code>shell.nix</code> made the Rails gem available, I used it to generate a new Rails app in a subdirectory with the <code>rails new</code> command:</p>

<pre><code>nix-shell --run 'rails new my-rails-app --skip-bundle --skip-webpack-install --database=postgresql'
</code></pre>

<p>This step created a vanilla Rails app in the <code>my-rails-app</code> subdirectory. Note that I chose to skip the <code>bundle install</code> and <code>rails webpacker:install</code> steps, because at this point the nix-shell could not provide everything necessary.</p>

<h3 id="bundled-gems">Bundled gems</h3>

<p>I felt as if generating the Rails app was separate from setting up and running it and so I decided to create a separate nix-shell within the "inner" subdirectory. This was achieved much as before, but this time based on the "inner" <code>Gemfile</code> generated as part of the new Rails app:</p>

<pre><code>cd my-rails-app

nix-shell -p ruby_2_6 bundler bundix --run 'bundle lock &amp;&amp; bundix --init --ruby=ruby_2_6'
</code></pre>

<p>This generated the following files in the subdirectory:</p>

<ul>
  <li><code>Gemfile.lock</code></li>
  <li><code>gemset.nix</code></li>
  <li><code>shell.nix</code></li>
</ul>

<h3 id="runtime-dependencies">Runtime dependencies</h3>

<p>While the <code>shell.nix</code> file in combination with the <code>gemset.nix</code> would make the bundled gems and their dependent OS packages available within the nix-shell, I also needed to add some runtime dependencies (<code>nodejs</code>, <code>yarn</code> &amp; <code>ruby_2_6</code>) for subsequent steps by adding them to the list of <code>buildInputs</code> in <code>shell.nix</code>:</p>

<pre><code>buildInputs = [ env nodejs yarn ruby_2_6 ];
</code></pre>

<h3 id="postgresql-package">PostgreSQL package</h3>

<p>Having specified PostgreSQL as the database when I generated the Rails app, I wanted to setup and start a PostgreSQL server in the nix-shell development environment. So I also added the postgresql package to the list of <code>buildInputs</code>:</p>

<pre><code>buildInputs = [ env nodejs yarn postgresql ruby_2_6 ];
</code></pre>

<h3 id="webpacker">Webpacker</h3>

<p>The "inner" nix-shell was now ready to install webpacker using the <code>rails webpacker:install</code> command.</p>

<pre><code>nix-shell&gt; rails webpacker:install
</code></pre>

<p>Running the "inner" nix-shell for the first time resulted in the bundled gems and their OS dependencies being installed along with runtime dependencies mentioned above. I found it pretty cool seeing that e.g. the <code>libxml2</code> OS package was automatically installed just because <code>nokogiri</code> was in the bundled gems!</p>

<h3 id="postgresql-server">PostgreSQL server</h3>

<p>I wanted a PostgreSQL database server to be available, but only from <em>within</em> the nix-shell, i.e. not system-wide. To this end I added a <a href="https://nixos.org/manual/nix/stable/#description-13"><code>shellHook</code></a> to <code>shell.nix</code> to idempotently configure the server and start it when entering the nix-shell:</p>

<pre><code>shellHook = ''
  export PGHOST=$HOME/postgres
  export PGDATA=$PGHOST/data
  export PGDATABASE=postgres
  export PGLOG=$PGHOST/postgres.log

  mkdir -p $PGHOST

  if [ ! -d $PGDATA ]; then
    initdb --auth=trust --no-locale --encoding=UTF8
  fi

  if ! pg_ctl status
  then
    pg_ctl start -l $PGLOG -o "--unix_socket_directories='$PGHOST'"
  fi
'';
</code></pre>

<p>I set the database server up with minimal security to make it easy to access from <code>psql</code> and so the generated <code>database.yml</code> would just work out of the box.</p>

<h3 id="rails-development-environment">Rails development environment</h3>

<p>By this stage, the nix-shell Rails development environment was pretty much ready to go. To make things slightly more interesting, I decided to create the canonical simple Rails "blog" app using the <code>rails generate scaffold</code> command:</p>

<pre><code>nix-shell&gt; rails generate scaffold post title:string content:text
</code></pre>

<p>I then created and migrated the development and test databases for the Rails app in the usual way:</p>

<pre><code>nix-shell&gt; rails db:create
nix-shell&gt; rails db:migrate
</code></pre>

<p>And ran the Rails tests as follows:</p>

<pre><code>nix-shell&gt; rails test
</code></pre>

<p>And finally, the moment of truth (!), I ran the Rails server and opened a browser at the home page 🚀:</p>

<pre><code>nix-shell&gt; rails server --binding 0.0.0.0 --daemon
nix-shell&gt; open http://localhost:3000/
</code></pre>

<p><img style="display: block; margin-left: auto; margin-right: auto; width: 80%;" src="/images/rails-welcome.png" alt="Rails welcome page" /></p>

<p>The blogging functionality was also accessible at <a href="http://localhost:3000/posts">the relevant endpoint</a> and seemed to persist new posts successfully.</p>

<h3 id="trying-it-yourself">Trying it yourself</h3>

<p>If you want to follow along at home, I've published the source code in <a href="https://github.com/floehopper/rails-on-nix">a GitHub repository</a>. The steps I've described above are documented in the <a href="https://github.com/floehopper/rails-on-nix/blob/main/README.md">README</a> and the corresponding code is in a couple of inline provisioning scripts within the <a href="https://github.com/floehopper/rails-on-nix/blob/main/Vagrantfile"><code>Vagrantfile</code></a>.</p>

<h3 id="observations">Observations</h3>

<ul>
  <li>
    <p>Very belatedly, I came across the <code>--pure</code> option for nix-shell which might've been a simpler way to isolate my development environment. However, <a href="https://nixos.org/manual/nix/stable/#name-2">the documentation</a> says: "Note that <code>~/.bashrc</code> and (depending on your Bash installation) <code>/etc/bashrc</code> are still sourced, so any variables set there will affect the interactive shell." The latter was the main source of my previous isolation woes, so perhaps it wouldn't have helped that much after all.</p>
  </li>
  <li>
    <p>Initially I wanted to have the database-related directories <em>within</em> the Rails app project directory, but it turned out I couldn't do this because VirtualBox doesn't allow hard links within shared directories (at least not on MacOS). And so I put them in the user's home directory instead. If I was doing this "for real", I wouldn't be on a VirtualBox VM and so putting them in the Rails app project directory wouldn't be an issue.</p>
  </li>
  <li>
    <p>I decided not to worry about shutting down the database server when exiting the nix-shell, but I believe this would be fairly straightforward using the Linux <code>trap</code> command.</p>
  </li>
  <li>
    <p>I discovered that in Nix Ruby packages the Rails gem is <a href="https://github.com/NixOS/nixpkgs/blob/e0c48efc170866a8889b6b758aac10e6d04a4d9b/pkgs/top-level/ruby-packages.nix#L1893-L1903">fixed at v4.2.11.1</a>. I didn't want to use such an old version and so I ended up using Bundler and Bundix in conjunction with a <code>Gemfile</code> to make a newer version of Rails available. If the version in Nix Ruby packages was more up-to-date, I believe I could have used something much simpler, e.g.</p>
  </li>
</ul>
<pre><code>nix-shell -p 'ruby_2_6.gems.rails' --run 'rails new my-rails-app --skip-bundle --skip-webpack-install --database=postgresql'
</code></pre>

<h3 id="next-steps">Next steps</h3>

<ul>
  <li>
    <p>Multiple Rails app with different database types and versions. This is really the core issue I'm trying to solve by setting my development environment up using Nix.</p>
  </li>
  <li>
    <p>Investigate using Nix to somehow make Node packages available to the environment in a similar way to Bundix instead of using Yarn directly, i.e. also automatically installing any OS package dependencies.</p>
  </li>
  <li>
    <p>Investigate using <a href="https://nixos.wiki/wiki/Home_Manager">Nix home-manager</a> to provide a more generic environment on the VM to create the Rails app, i.e. to be able to run <code>rails new</code>.</p>
  </li>
</ul>

<h3 id="further-reading">Further reading</h3>

<ul>
  <li>
    <p>Someone on the Nix forums pointed me at <a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/ruby.section.md">this Ruby guide for Nix</a> which for some reason hasn't been incorporated into the main Nix documentation.</p>
  </li>
  <li>
    <p>At various points I've found it useful to dive into the source code of the <a href="https://github.com/NixOS/nixpkgs/tree/master/pkgs/development/ruby-modules">Nix Ruby modules</a>. This was particularly useful when I was trying to understand how Bundix worked.</p>
  </li>
</ul>


    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2020-10-12-generating-and-running-a-rails-app-with-postgresql-using-nix-on-ubuntu"><time class="dt-published" datetime="2020-10-12T20:20:00+00:00">12 Oct 2020 at 20:20</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2020-10-12-generating-and-running-a-rails-app-with-postgresql-using-nix-on-ubuntu">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8"></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell" class="previous">&lt; A simple Rails development environment using nix-shell</a>
      <a href="/blog/2020-10-13-sending-webmentions-from-a-static-website" class="next">Automatically sending Webmentions from a static website &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <p xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0<img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" /><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" /><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" /></a></p>
      </footer>
    </div>
  </body>
</html>
