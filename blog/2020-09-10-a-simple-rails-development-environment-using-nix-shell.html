<!DOCTYPE html>
<html lang="en">
  <head>
    <title>A simple Rails development environment using nix-shell - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="This nix-shell environment provides a Ruby environment capable of running a Rails app without a database" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2020-08-07-using-nix-to-build-my-personal-website" />
    <link rel="next" href="/blog/2020-10-12-generating-and-running-a-rails-app-with-postgresql-using-nix-on-ubuntu" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-05-18-how-to-backup-google-drive-to-s3-using-the-aws-cdk" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2020-09-10-a-simple-rails-development-environment-using-nix-shell" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">A simple Rails development environment using nix-shell</h1>
        <h2 class="p-summary">This nix-shell environment provides a Ruby environment capable of running a Rails app without a database</h2>
    </header>

    <section class="e-content">
      <p>This follows on from my previous article about setting up <a href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell">a simple Ruby development environment using nix-shell</a>. The next thing I wanted to try was to set up a simple Rails development environment. To this end I decided to focus on <a href="https://github.com/freerange/site">the GFR website</a> which is a Rails app, but has the advantage that it doesn't use a database.</p>

<p>The <code>Gemfile</code> for this project specified Ruby v2.5.7 and so <a href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell#a-ruby-development-environment-using-nix-shell">as before</a>, I <a href="https://github.com/freerange/site/commit/75ae0e850fd0d8bf9c7abf48a543fdc9607f3dc4#diff-8b7db4d5cc4b8f6dc8feb7030baa2478">upgraded</a> it to use the latest v2.5 patch version, v2.5.8, so that I could use the ruby_2_5 package provided by nix.</p>

<p>In a similar vein, the <code>Gemfile.lock</code> was <code>BUNDLED WITH</code> v1.17.3 of bundler; whereas the bundler version <a href="https://github.com/NixOS/nixpkgs/blob/b71dc9d264ef0bad32de437ec9105000c952654d/pkgs/development/ruby-modules/bundler/default.nix#L7">provided by nixpkgs</a> was v2.1.4. The line in <code>Gemfile.lock</code> wasn't an enforced constraint and I didn't want to break our Heroku deployment, so I compromised and upgraded to the v2 version of bundler <a href="https://devcenter.heroku.com/articles/ruby-support#libraries">supported by the Heroku Ruby buildpack</a>, i.e. v2.0.2.</p>

<p>My <code>shell.nix</code> ended up like this:</p>

<pre><code>with (import &lt;nixpkgs&gt; {});
let
  env = bundlerEnv {
    name = "site-bundler-env";
    ruby = ruby_2_5;
    gemdir  = ./.;
  };
in mkShell {
  buildInputs = [ env env.wrappedRuby ];
}
</code></pre>

<p>The full set of changes including the <code>gemset.nix</code> generated by bundix are in <a href="https://github.com/freerange/site/commit/8e5f37af715829d27c57e0f5e8a38e6f36b44b01">this commit</a>.</p>

<p>At this point I was surprised to discover that I could run <code>rails server</code> from within my <code>nix-shell</code> and everything worked perfectly! ðŸš€</p>

<pre><code>$ nix-shell

# ...

$ rails s
=&gt; Booting Puma
=&gt; Rails 5.2.4.3 application starting in development
=&gt; Run `rails server -h` for more startup options

# ...

Started GET "/" for ::1 at 2020-09-10 18:05:37 +0100
Processing by PagesController#show as HTML

# ...

Completed 200 OK in 170ms (Views: 23.9ms)
</code></pre>

<h3 id="observations">Observations</h3>

<p>It's worth noting that early on in the shenanigans above, I got stuck for a while with the wrong version of Ruby and nothing I did would change it. In the end I deleted a bunch of things in my <code>/nix/store</code> directory to fix the problem. While this probably wasn't the <em>right</em> way to fix it, I really appreciated the way it's relatively easy to work out how various executables are being made available to your environment, i.e. via a series of symbolic links.</p>

<p>I also worked out that it's not possible (at least not when using <code>bundlerEnv</code>) to specify the version of bundler you want to use - it seems to be <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/ruby-modules/bundler/default.nix#L7">fixed at v2.1.4</a>.</p>

<h3 id="next-steps">Next steps</h3>

<p>I'm still interested in working out how to have a project use a specific patch version of Ruby and to be able to lockdown the exact version of bundler. I've been reading about <a href="https://github.com/NixOS/rfcs/pull/49">nix flakes</a> and although I haven't completely got my head around them, I think they <em>might</em> be what I'm looking for, because they have a "lock file" which I believe can pin your dependencies to ensure reproducibility.</p>

<p>However, I still feel as if that's a bit of a tangent. My main aim is to be able to have multiple Rails projects on the same computer with various flavours and versions of databases, etc. So I think my next step should be to setup a development environment for a Rails project which uses a database.</p>

<p id="runtime-dependencies-update"><em>Update</em>: I've belatedly realised that some run-time dependencies (e.g. node.js &amp; yarn) were satisfied by OS packages installed in my OSX environment, i.e. I forgot to isolate the nix shell from this environment like I did when investigating the dependency on node.js in my previous article. I plan to tackle doing this soon.</p>

<h3 id="further-reading">Further reading</h3>

<p>If you'd like to know more about nix flakes, I can recommend these articles by <a href="https://edolstra.github.io/">Eelco Dolstra</a>:</p>

<ul>
  <li><a href="https://www.tweag.io/blog/2020-05-25-flakes/">Nix Flakes, Part 1: An Introduction and Tutorial</a></li>
  <li><a href="https://www.tweag.io/blog/2020-06-25-eval-cache/">Nix Flakes, Part 2: Evaluation Caching</a></li>
  <li><a href="https://www.tweag.io/blog/2020-07-31-nixos-flakes/">Nix Flakes, Part 3: Managing NixOS Systems</a></li>
</ul>


    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell"><time class="dt-published" datetime="2020-09-10T18:21:00+00:00">10 Sep 2020 at 18:21</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8"></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2020-08-07-using-nix-to-build-my-personal-website" class="previous">&lt; Using nix to build my personal website</a>
      <a href="/blog/2020-10-12-generating-and-running-a-rails-app-with-postgresql-using-nix-on-ubuntu" class="next">Generating and running a Rails app with PostgreSQL using Nix on Ubuntu &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <p xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0<img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" /><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" /><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" /></a></p>
      </footer>
    </div>
  </body>
</html>
