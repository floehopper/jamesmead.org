<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Using nix to build my personal website - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Modifying the existing GitHub Action workflow for building the website to use cachix/install-nix-action and nix-shell" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js" defer="defer"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell" />
    <link rel="next" href="/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-11-01-mocha-v2-release" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2020-08-07-using-nix-to-build-my-personal-website" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/adventures/">Adventures</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">Using nix to build my personal website</h1>
        <h2 class="p-summary">Modifying the existing GitHub Action workflow for building the website to use cachix/install-nix-action and nix-shell</h2>
    </header>

    <section class="e-content">
      <p>This is a follow-up to my previous article about setting up <a href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell">a simple Ruby development environment using nix-shell</a> in which I mentioned I wasn't certain I'd <em>completely</em> specified the development environment. Although it's a bit of a tangent from my main aim of configuring isolated <em>development</em> environments, I thought it would be instructive to modify <a href="/blog/2019-09-07-using-github-actions-to-publish-a-static-site-to-github-pages">the GitHub Action workflow that automatically publishes this website</a> to use <a href="https://nixos.org/">nix</a>.</p>

<h3 id="modifying-the-github-action-workflow-to-use-nix">Modifying the GitHub action workflow to use nix</h3>

<p>I found <a href="https://github.com/cachix/install-nix-action">cachix/install-nix-action</a> and decided to use it in my workflow along with the <code>shell.nix</code> &amp; <code>gemset.nix</code> files I'd already created. I had to remove the specification of a "ruby:2.6.6" container image, because this did not include a number of packages required by the install-nix-action step to install nix. Removing this specification meant that the workflow fell back to using GitHub's "ubuntu-latest" virtual environment which comes with <a href="https://github.com/actions/virtual-environments/blob/master/images/linux/Ubuntu1804-README.md">loads of OS packages</a> installed including those needed to install nix.</p>

<p>I then inserted the install-nix-action step immediately after the existing <a href="https://github.com/actions/checkout">actions/checkout</a> step, removed the steps installing node.js and the bundled gems, and modified the step which built the website to run <code>nix-shell --command 'middleman build'</code>, i.e. to build the site within the shell specified by <code>shell.nix</code>.</p>

<p>At this point slightly to my amazement, the build ran successfully!</p>

<pre><code>name: Continuous Deployment to GitHub Pages
on:
  push:
    branches:
      - main
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@master
      - uses: cachix/install-nix-action@v10
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Build site
        run: nix-shell --command 'middleman build'
      - name: Publish site
        uses: maxheld83/ghpages@v0.2.1
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          BUILD_DIR: ./build
</code></pre>

<p>You can see all the changes I made in <a href="https://github.com/floehopper/jamesmead.org/commit/cee581de9849fa721bf621fe58553458b17e83c5">this commit</a>.</p>

<h3 id="observations">Observations</h3>

<p>As with the experience of running nix-shell on my local machine, I belatedly realised node.js was being made available by the GitHub virtual environment and not by nix-shell. I did spend a bit of time investigating this by basing the workflow on a minimal container image, but it turns out that it's not trivial to prepare a container image suitable for installing nix. So I decided to give up at this point. Although it meant I still hadn't definitively proved I'd <em>completely</em> specified the development environment, I'd convinced myself that I understood what was going on and could prove it given enough time!</p>

<p>I was pleasantly surprised to see that the nix-based build were significantly quicker than the original build, even though the bundled gems were being cached in the latter. Some of the speed-up can be attributed to the fact that the nix-based build doesn't have to spin up a separate container, but from a cursory look at the logs most of the gain seems to be in not having to install the bundled gems.</p>

<ul>
  <li><a href="https://github.com/floehopper/jamesmead.org/actions/runs/183152555">Building without nix-shell</a> 4 mins 48 secs</li>
  <li><a href="https://github.com/floehopper/jamesmead.org/actions/runs/183290575">Building with nix-shell</a> 1 min 44 secs</li>
</ul>

<h3 id="next-steps">Next steps</h3>

<p>While this was an interesting diversion, I plan to get back on track by creating a development environment for a simple Rails app, probably <a href="https://github.com/freerange/site">this one</a> which doesn't need a database.</p>


    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2020-08-07-using-nix-to-build-my-personal-website"><time class="dt-published" datetime="2020-08-07T11:32:00+00:00">07 Aug 2020 at 11:32</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2020-08-07-using-nix-to-build-my-personal-website">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8" defer></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2020-07-26-a-simple-ruby-development-environment-using-nix-shell" class="previous">&lt; A simple Ruby development environment using nix-shell</a>
      <a href="/blog/2020-09-10-a-simple-rails-development-environment-using-nix-shell" class="next">A simple Rails development environment using nix-shell &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <div id="indieweb-ring">
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/previous">‚Üê</a>
          An IndieWeb Webring üï∏üíç
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/next">‚Üí</a>
        </div>
        <p id="creative-commons" xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">
          This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under
          <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons logo" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons Attribution icon" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons ShareAlike icon" />
          </a>
        </p>
      </footer>
    </div>
  </body>
</html>
