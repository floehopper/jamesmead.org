<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Automatic backup of Trello boards to S3 using the AWS CDK - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Replacing a cron job with a flock of AWS Lambda functions written in Ruby" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js" defer="defer"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2019-09-07-using-github-actions-to-publish-a-static-site-to-github-pages" />
    <link rel="next" href="/blog/2020-06-27-indieweb-ifying-my-personal-website" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-11-01-mocha-v2-release" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2020-03-30-automatic-backup-of-trello-boards-to-s3-using-aws-cdk" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/adventures/">Adventures</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">Automatic backup of Trello boards to S3 using the AWS CDK</h1>
        <h2 class="p-summary">Replacing a cron job with a flock of AWS Lambda functions written in Ruby</h2>
    </header>

    <section class="e-content">
      <p>Over the last year or so, I've been using the <a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html">AWS CDK</a> to setup AWS infrastructure for a number of internal <a href="https://gofreerange.com/">Go Free Range</a> projects and I thought I'd try to write a bit about my experiences.</p>

<p>I started off by converting an existing project which backed up our company <a href="https://trello.com/">Trello</a> boards to an AWS S3 bucket. This was originally a relatively simple Ruby script which ran as a cron job on our <a href="https://www.linode.com/">Linode</a> VPS. The script used the Trello API (via <code>Net::HTTP</code>) to list the company boards and then downloaded a single large JSON blob for each board. It then used the the Ruby version of the <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/developer-guide/welcome.html">AWS SDK</a> to save each JSON blob to a file in a versioned S3 bucket.</p>

<p>At around that time a Ruby runtime had been introduced for AWS Lambda functions, so I decided to give that a go. The first thing I had to work out was how to trigger a Lambda function to execute on a cron-like schedule. It took me a while to figure out the best way to do this, but eventually I worked out I could use a <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html">Schedule Expression</a> for a CloudWatch Rule.</p>

<p>Next I realised that I couldn't just move the whole of the existing Ruby script into the new Lambda function, because it would almost certainly timeout. And in any case, long-running Lambda functions aren't really in the spirit of <a href="https://en.wikipedia.org/wiki/Serverless_computing">server-less computing</a>! Anyway, after a number of false starts, I split the script up into a function to <em>enumerate</em> the relevant Trello boards and another to <em>backup</em> an individual Trello board to S3. The former is invoked by a scheduled CloudWatch event and for each Trello board it publishes a message to an <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/SNS/Topic.html">SNS Topic</a> using the AWS SDK.</p>

<p>The second Lambda function is subscribed to the SNS Topic so that an instance of the function is invoked for each Trello board. The function fetches the JSON blob for the board identified by the SNS message and saves it to an S3 bucket in much the same way as the original script did. Thus the work fans out from one initial function to multiple secondary functions.</p>

<p><img style="display: block; margin-left: auto; margin-right: auto; width: 80%;" src="/images/aws-cdk-trello-backup.svg" alt="Automatic backup of Trello boards to S3 using the AWS CDK" /></p>

<p>Previously if a cron job failed on our VPS, it would email us via <a href="http://www.postfix.org/">Postfix</a>. While I could view the CloudWatch logs for the Lambda functions to spot any errors in the new system, I couldn't immediately see a way to replicate the original behaviour, because with my new Lambda function "fan-out" architecture there was no easy way to know when all backup functions had completed successfully. However, I'll save that for another blog post!</p>

<p>If you're interested you can find <a href="https://github.com/freerange/trello-backup">the source code on GitHub</a>.</p>


    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2020-03-30-automatic-backup-of-trello-boards-to-s3-using-aws-cdk"><time class="dt-published" datetime="2020-03-30T16:40:00+00:00">30 Mar 2020 at 16:40</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2020-03-30-automatic-backup-of-trello-boards-to-s3-using-aws-cdk">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8" defer></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2019-09-07-using-github-actions-to-publish-a-static-site-to-github-pages" class="previous">&lt; Using GitHub Actions to publish a static site to GitHub Pages</a>
      <a href="/blog/2020-06-27-indieweb-ifying-my-personal-website" class="next">IndieWeb-ifying my personal website &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <div id="indieweb-ring">
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/previous">‚Üê</a>
          An IndieWeb Webring üï∏üíç
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/next">‚Üí</a>
        </div>
        <p id="creative-commons" xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">
          This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under
          <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons logo" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons Attribution icon" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons ShareAlike icon" />
          </a>
        </p>
      </footer>
    </div>
  </body>
</html>
