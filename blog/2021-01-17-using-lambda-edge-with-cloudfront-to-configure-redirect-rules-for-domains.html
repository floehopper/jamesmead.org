<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Using Lambda@Edge with CloudFront to configure redirect rules for domains - James Mead</title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="An AWS CDK project to create CloudFront distributions with Lambda@Edge functions to replace Apache and mod_rewrite rules" />
    <meta name="author" content= "James Mead" />

    <meta name="verify-v1" content="H0rIfyqCDW+br6ieZtuZ+Hnt3ii3FpF22qFYjZmO+3E=" />
    <meta name="y_key" content="5f5b0de20991e0c2" />
    <meta name="msvalidate.01" content="5D5476B4F9F70AAFE14D519093E3FFA8" />

    <link href="/images/favicon.gif" rel="icon" type="image/gif" />

    <link href="/stylesheets/yui/3.18.1/cssreset-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssfonts-min.css" rel="stylesheet" /><link href="/stylesheets/yui/3.18.1/cssbase-min.css" rel="stylesheet" />

    <link href="/stylesheets/site.css" rel="stylesheet" />

    <link href="/stylesheets/prettify/prettify.css" rel="stylesheet" />
    <script src="/javascripts/prettify/prettify.js" defer="defer"></script>

    <link rel="alternate" type="application/atom+xml" title="Atom" href="http://feeds.jamesmead.org/floehopper-blog" />

    <link rel="webmention" href="https://webmention.io/jamesmead.org/webmention" />

    <link rel="prev" href="/blog/2020-11-29-multiple-rails-development-environments-using-nix-shell" />
    <link rel="next" href="/blog/2021-01-23-youtube-video-of-my-3d-maze-game-for-the-zx-spectrum" />
    <link rel="first" href="/blog/2004-05-14-unit-tests-can-100-coverage-be-a-bad-thing" />
    <link rel="last" href="/blog/2022-05-18-how-to-backup-google-drive-to-s3-using-the-aws-cdk" />
    <link rel="index" href="/blog" />

  </head>
  <body class="blog blog_2021-01-17-using-lambda-edge-with-cloudfront-to-configure-redirect-rules-for-domains" onload="prettyPrint()">
    <div id="doc">
      <div class="skip-links">
        <a href="#bd">Skip to main content</a>
      </div>

      <header id="hd">
        <nav aria-label="Primary">
          <a href="/">Home</a>
          &middot;
          <a href="/blog/">Blog</a>
          &middot;
          <a href="/notes/">Notes</a>
          &middot;
          <a href="/talks/">Talks</a>
          &middot;
          <a href="/projects/">Projects</a>
        </nav>
      </header>

      <main id="bd">
          <article class="h-entry">
    <header>
      <h1 class="p-name">Using Lambda@Edge with CloudFront to configure redirect rules for domains</h1>
        <h2 class="p-summary">An AWS CDK project to create CloudFront distributions with Lambda@Edge functions to replace Apache and mod_rewrite rules</h2>
    </header>

    <section class="e-content">
      <p>I'm a big fan of <a href="https://www.w3.org/Provider/Style/URI">cool URLs</a> and not <a href="https://gofreerange.com/broken-rubyforge-urls">breaking the internet</a> and so over the years I've accumulated a few domains for which I've implemented a lot of redirect rules. In recent years I've implemented these rules using <a href="https://httpd.apache.org/docs/current/mod/mod_rewrite.html">mod_rewrite</a> and run them on <a href="https://httpd.apache.org/">Apache</a> and on my <a href="https://www.linode.com/">Linode</a> VPS, e.g. <a href="https://github.com/floehopper/jamesmead.org/blob/b3db4135b3b90b96e50e99edf0551a52e0dc240f/config/sites-available/blog.floehopper.org.conf">the redirect rules for <code>blog.floehopper.org</code></a>.</p>

<p>However, in September 2019 I started <a href="https://jamesmead.org/blog/2019-09-07-using-github-actions-to-publish-a-static-site-to-github-pages">publishing this website on GitHub Pages</a> and over the intervening period I've removed pretty much everything else I was running on that VPS. And so I'd started thinking it would be nice to shutdown the VPS and stop paying for it! The legacy redirects mentioned above were the only things preventing me from doing this.</p>

<p>In the last 18 months I've used the <a href="https://aws.amazon.com/cdk/">AWS CDK</a> quite a bit both at work and for personal projects. Unfortunately I've only got round to publishing <a href="2020-03-30-automatic-backup-of-trello-boards-to-s3-using-aws-cdk">one article about it</a> (something I hope to remedy in the not too distant future). Anyway, I'd read a bit about <a href="https://aws.amazon.com/lambda/edge/">Lambda@Edge</a> and noticed that it was indeed supported by <a href="https://aws.amazon.com/cloudformation/">CloudFormation</a> and the AWS CDK, so I thought I'd give it a whirl.</p>

<p>My basic idea was to create a <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-cloudfront.Distribution.html">CloudFront distribution</a>, associate a custom domain with it, configure <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-cloudfront-readme.html#lambdaedge">an Edge Lambda function</a> to handle all requests to that distribution and implement the appropriate redirects in JavaScript, then point the relevant DNS records at the CloudFront distribution.
This turned out to be pretty straightforward, although I did have to use the <a href="https://aws.amazon.com/certificate-manager/">AWS Certificate Manager</a> to <a href="https://github.com/floehopper/edge-redirector/blob/da128e7dc42fe89b09d496a2b5e68f4aaa931f78/create-ssl-certificate.sh">create an SSL certificate</a> for the domain to get everything to work.</p>

<p>You can find the full project source code <a href="https://github.com/floehopper/edge-redirector">on GitHub</a>. I'm afraid I haven't yet got round to updating the README from the default version generated by the AWS CDK. If you prefer, here's a slightly cut down version of a couple of key project files illustrating how I did this for the <code>blog.floehopper.org</code> domain:</p>

<pre class="prettyprint lang-js">
  <code>
    # file: lib/edge-redirector-stack.ts

    import * as cdk from '@aws-cdk/core';
    import * as lambda from '@aws-cdk/aws-lambda';
    import * as cloudfront from '@aws-cdk/aws-cloudfront';
    import * as origins from '@aws-cdk/aws-cloudfront-origins';
    import * as acm from '@aws-cdk/aws-certificatemanager';

    export class EdgeRedirectorStack extends cdk.Stack {
      constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
        super(scope, id, props);

        this.createDistribution('blog.floehopper.org', 'blogFloehopperOrg', 'arn:aws:acm:us-east-1:687105911108:certificate/aa11ee5a-54db-4a04-8307-f77330f86cb5');
      }

      createDistribution(domain: string, handler: string, certificateArn: string) {
        const certificate = acm.Certificate.fromCertificateArn(this, `${handler}Certificate`, certificateArn);
        new cloudfront.Distribution(this, `${handler}Distribution`, {
          defaultBehavior: {
            origin: new origins.HttpOrigin('example.com'),
            edgeLambdas: [
              {
                eventType: cloudfront.LambdaEdgeEventType.VIEWER_REQUEST,
                functionVersion: this.redirectVersion(domain, handler)
              }
            ]
          },
          domainNames: [domain],
          certificate: certificate,
          enableLogging: true
        });
      }

      redirectVersion(domain: string, handler: string) : lambda.IVersion {
        const redirectFunction = new cloudfront.experimental.EdgeFunction(this, `${handler}Redirect`, {
          runtime: lambda.Runtime.NODEJS_12_X,
          handler: `${handler}.handler`,
          code: lambda.Code.fromAsset('./lambdaFunctions/redirect')
        });

        return redirectFunction.currentVersion;
      }
    }
  </code>
</pre>

<pre class="prettyprint lang-js">
  <code>
    # file: lambdaFunctions/redirect/blogFloehopperOrg.js

    'use strict';

    exports.handler = function(event, context, callback) {
      const request = event.Records[0].cf.request;

      const mapping = [
        // Legacy Typo-style articles
        ['^/articles/([0-9]{4})/([0-9]{2})/([0-9]{2})/(.+)$', (m) =&gt; `http://jamesmead.org/blog/${m[1]}-${m[2]}-${m[3]}-${m[4]}`],

        // Redirect blog.floehopper.org -&gt; jamesmead.org
        ['^/(.*)$', (m) =&gt; `http://jamesmead.org/${m[1]}`],
        ['^$', (m) =&gt; `http://jamesmead.org`],
    ];

      let redirectUrl;
      for (const [pattern, url] of mapping) {
        const match = request.uri.match(new RegExp(pattern));
        if (match) {
          if (typeof(url) == 'function') {
            redirectUrl = url(match);
          } else {
            redirectUrl = url;
          };
          break;
        };
      };

      let response;

      if (redirectUrl) {
        response = {
          status: '301',
          statusDescription: 'Moved Permanently',
          headers: {
            location: [{
              key: 'Location',
              value: redirectUrl
            }],
          }
        };
      } else {
        response = {
          status: '404',
          statusDescription: 'Not Found'
        };
      };

      callback(null, response);
    };
  </code>
</pre>


    </section>

    <footer>
      <p class="metadata">
        Published by <a class="p-author h-card" href="https://jamesmead.org/">James Mead</a> on <a class="u-url" href="https://jamesmead.org/blog/2021-01-17-using-lambda-edge-with-cloudfront-to-configure-redirect-rules-for-domains"><time class="dt-published" datetime="2021-01-17T16:38:00+00:00">17 Jan 2021 at 16:38</time></a>
      </p>
      <div class="webmentions" data-webmentions="https://jamesmead.org/blog/2021-01-17-using-lambda-edge-with-cloudfront-to-configure-redirect-rules-for-domains">
  <template id="webmention-template">
    <li class="webmention">
      <div>
        <a class="author">
          <span class="author-name"></span>
        </a>
        <a class="action"></a>
      </div>
      <div class="content"></div>
    </li>
  </template>
</div>

<script src="/javascripts/webmentions.js" type="text/javascript" charset="utf-8" defer></script>

    </footer>
  </article>


          <nav id="navigation" aria-label="Inter-article">
      <a href="/blog/2020-11-29-multiple-rails-development-environments-using-nix-shell" class="previous">&lt; Multiple Rails development environments using nix-shell</a>
      <a href="/blog/2021-01-23-youtube-video-of-my-3d-maze-game-for-the-zx-spectrum" class="next">Youtube video of my 3D maze game for the ZX Spectrum &gt;</a>
  </nav>

      </main>

      <footer id="ft">
        <nav style="float: left" aria-label="Footer">
          <a href="/contact">Contact</a>
          &middot;
          <a href="/history">History</a>
          &middot;
          <a href="/colophon">Colophon</a>
          &middot;
          <a href="/links">Links</a>
        </nav>
        <div style="float: right">
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/previous">‚Üê</a>
          An IndieWeb Webring üï∏üíç
          <a href="https://xn--sr8hvo.ws/%F0%9F%93%BF%F0%9F%8C%91%F0%9F%A6%82/next">‚Üí</a>
        </div>
        <p style="clear: both" xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#" class="license-text">
          This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="jamesmead.org">James Mead</a> is licensed under
          <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons logo" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons Attribution icon" />
            <img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" loading="lazy" alt="Creative Commons ShareAlike icon" />
          </a>
        </p>
      </footer>
    </div>
  </body>
</html>
