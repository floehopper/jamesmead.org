---
title: Using Lambda@Edge with CloudFront to configure redirect rules for domains
description: An AWS CDK project to create CloudFront distributions with Lambda@Edge functions to replace Apache and mod_rewrite rules
created_at: 2021-01-17 16:38:00 +00:00
updated_at: 2021-01-17 16:38:00 +00:00
guid: 05fc7138-2985-481a-ab79-72a5835fecd7
---

I'm a big fan of [cool URLs][] and not [breaking the internet][broken-rubyforge-urls] and so over the years I've accumulated a few domains for which I've implemented a lot of redirect rules. In recent years I've implemented these rules using [mod_rewrite][] and run them on [Apache][] and on my [Linode][] VPS, e.g. [the redirect rules for `blog.floehopper.org`][blog.floehopper.org.conf].

However, in September 2019 I started [publishing this website on GitHub Pages][publishing-to-gh-pages] and over the intervening period I've removed pretty much everything else I was running on that VPS. And so I'd started thinking it would be nice to shutdown the VPS and stop paying for it! The legacy redirects mentioned above were the only things preventing me from doing this.

In the last 18 months I've used the [AWS CDK][] quite a bit both at work and for personal projects. Unfortunately I've only got round to publishing [one article about it][trello-backup-article] (something I hope to remedy in the not too distant future). Anyway, I'd read a bit about [Lambda@Edge][] and noticed that it was indeed supported by [CloudFormation][] and the AWS CDK, so I thought I'd give it a whirl.

My basic idea was to create a [CloudFront distribution][], associate a custom domain with it, configure [an Edge Lambda function][] to handle all requests to that distribution and implement the appropriate redirects in JavaScript, then point the relevant DNS records at the CloudFront distribution.
This turned out to be pretty straightforward, although I did have to use the [AWS Certificate Manager][] to [create an SSL certificate][] for the domain to get everything to work.

You can find the full project source code [on GitHub][edge-redirector]. I'm afraid I haven't yet got round to updating the README from the default version generated by the AWS CDK. If you prefer, here's a slightly cut down version of a couple of key project files illustrating how I did this for the `blog.floehopper.org` domain:

<pre class="prettyprint lang-js">
  <code>
    # file: lib/edge-redirector-stack.ts

    import * as cdk from '@aws-cdk/core';
    import * as lambda from '@aws-cdk/aws-lambda';
    import * as cloudfront from '@aws-cdk/aws-cloudfront';
    import * as origins from '@aws-cdk/aws-cloudfront-origins';
    import * as acm from '@aws-cdk/aws-certificatemanager';

    export class EdgeRedirectorStack extends cdk.Stack {
      constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
        super(scope, id, props);

        this.createDistribution('blog.floehopper.org', 'blogFloehopperOrg', 'arn:aws:acm:us-east-1:687105911108:certificate/aa11ee5a-54db-4a04-8307-f77330f86cb5');
      }

      createDistribution(domain: string, handler: string, certificateArn: string) {
        const certificate = acm.Certificate.fromCertificateArn(this, `${handler}Certificate`, certificateArn);
        new cloudfront.Distribution(this, `${handler}Distribution`, {
          defaultBehavior: {
            origin: new origins.HttpOrigin('example.com'),
            edgeLambdas: [
              {
                eventType: cloudfront.LambdaEdgeEventType.VIEWER_REQUEST,
                functionVersion: this.redirectVersion(domain, handler)
              }
            ]
          },
          domainNames: [domain],
          certificate: certificate,
          enableLogging: true
        });
      }

      redirectVersion(domain: string, handler: string) : lambda.IVersion {
        const redirectFunction = new cloudfront.experimental.EdgeFunction(this, `${handler}Redirect`, {
          runtime: lambda.Runtime.NODEJS_12_X,
          handler: `${handler}.handler`,
          code: lambda.Code.fromAsset('./lambdaFunctions/redirect')
        });

        return redirectFunction.currentVersion;
      }
    }
  </code>
</pre>

<pre class="prettyprint lang-js">
  <code>
    # file: lambdaFunctions/redirect/blogFloehopperOrg.js

    'use strict';

    exports.handler = function(event, context, callback) {
      const request = event.Records[0].cf.request;

      const mapping = [
        // Legacy Typo-style articles
        ['^/articles/([0-9]{4})/([0-9]{2})/([0-9]{2})/(.+)$', (m) => `http://jamesmead.org/blog/${m[1]}-${m[2]}-${m[3]}-${m[4]}`],

        // Redirect blog.floehopper.org -> jamesmead.org
        ['^/(.*)$', (m) => `http://jamesmead.org/${m[1]}`],
        ['^$', (m) => `http://jamesmead.org`],
    ];

      let redirectUrl;
      for (const [pattern, url] of mapping) {
        const match = request.uri.match(new RegExp(pattern));
        if (match) {
          if (typeof(url) == 'function') {
            redirectUrl = url(match);
          } else {
            redirectUrl = url;
          };
          break;
        };
      };

      let response;

      if (redirectUrl) {
        response = {
          status: '301',
          statusDescription: 'Moved Permanently',
          headers: {
            location: [{
              key: 'Location',
              value: redirectUrl
            }],
          }
        };
      } else {
        response = {
          status: '404',
          statusDescription: 'Not Found'
        };
      };

      callback(null, response);
    };
  </code>
</pre>

[cool URLs]: https://www.w3.org/Provider/Style/URI
[broken-rubyforge-urls]: https://gofreerange.com/broken-rubyforge-urls
[Apache]: https://httpd.apache.org/
[mod_rewrite]: https://httpd.apache.org/docs/current/mod/mod_rewrite.html
[Linode]: https://www.linode.com/
[blog.floehopper.org.conf]: https://github.com/floehopper/jamesmead.org/blob/b3db4135b3b90b96e50e99edf0551a52e0dc240f/config/sites-available/blog.floehopper.org.conf
[publishing-to-gh-pages]: https://jamesmead.org/blog/2019-09-07-using-github-actions-to-publish-a-static-site-to-github-pages
[trello-backup-article]: 2020-03-30-automatic-backup-of-trello-boards-to-s3-using-aws-cdk
[AWS CDK]: https://aws.amazon.com/cdk/
[CloudFormation]: https://aws.amazon.com/cloudformation/
[Lambda@Edge]: https://aws.amazon.com/lambda/edge/
[CloudFront distribution]: https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-cloudfront.Distribution.html
[an Edge Lambda function]: https://docs.aws.amazon.com/cdk/api/latest/docs/aws-cloudfront-readme.html#lambdaedge
[AWS Certificate Manager]: https://aws.amazon.com/certificate-manager/
[create an SSL certificate]: https://github.com/floehopper/edge-redirector/blob/da128e7dc42fe89b09d496a2b5e68f4aaa931f78/create-ssl-certificate.sh
[edge-redirector]: https://github.com/floehopper/edge-redirector
